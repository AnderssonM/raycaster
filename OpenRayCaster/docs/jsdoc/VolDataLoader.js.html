<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Loaders/VolDataLoader.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: Loaders/VolDataLoader.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>from(js_root,"Loaders").import("GeneralDataLoader.js");
from(js_root).import("MissingMath.js");
/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * @constructor
 * @param {type} volumeData
 * @returns {VolDataLoader}
 */
function VolDataLoader(volumeData) {
    console.log("VolDataLoader constructor");
    GeneralDataLoader.call(this);
    this.onError = function (mess, color) {
        console.error("VolumeData:err:" + mess);
    };
    this.volumeData = volumeData;
}

VolDataLoader.prototype = Object.create(GeneralDataLoader.prototype);


VolDataLoader.prototype.load = function (URL) {
    this.loadURL(URL);
};

VolDataLoader.prototype.done = function (responseData) {

    console.log("VolDataLoader: data loaded", responseData);

    var header = new DataView(responseData, 0, 7 * 4);
    var src_width = header.getInt32(0);
    var src_height = header.getInt32(1 * 4);
    var src_depth = header.getInt32(2 * 4);

    var width = MissingMath.nextPow2(src_width);
    var height = MissingMath.nextPow2(src_height);
    var depth = MissingMath.nextPow2(src_depth);

    var offset_x = Math.round((width - src_width) / 2);
    var offset_y = Math.round((height - src_height) / 2);
    var offset_z = Math.round((depth - src_depth) / 2);

    console.log("VolumeData: dimensions (x,y,z)", src_width, src_height, src_depth);
    console.log("VolumeData: offset (x,y,z)", offset_x, offset_y, offset_z);
    var gf = MissingMath.greatestFactors(depth);

    this.volumeData.setDimensions(width, height, depth, gf.high, gf.low);
    this.volumeData.scalex = header.getFloat32(4 * 4);
    this.volumeData.scaley = header.getFloat32(5 * 4);
    this.volumeData.scalez = header.getFloat32(6 * 4);
    var src = new Uint8Array(responseData.slice(7 * 4));

    var scale_max = Math.max(Math.max(this.volumeData.scalex, this.volumeData.scaley), this.volumeData.scalez);

    this.volumeData.scalex /= scale_max;
    this.volumeData.scaley /= scale_max;
    this.volumeData.scalez /= scale_max;
    this.volumeData.maxVal = Number.NEGATIVE_INFINITY;
    this.volumeData.minVal = Number.POSITIVE_INFINITY;
    this.volumeData.avgVal = 0;
    this.volumeData.sumVal = 0;
    var val;

    for (var i = 0; i &lt; src_width * src_height * src_depth; i++) {
        val = src[ i ];
        this.volumeData.maxVal = Math.max(this.volumeData.maxVal, val);
        this.volumeData.minVal = Math.min(this.volumeData.minVal, val);
        this.volumeData.sumVal += val;
    }
    this.volumeData.avgVal = this.volumeData.sumVal / (src_depth * src_width * src_height);
    var mul = this.volumeData.sampleRangeMax / this.volumeData.maxVal;
    console.log("VolumeData: scale (x,y,z)", this.volumeData.scalex, this.volumeData.scaley, this.volumeData.scalez);
    console.log("VolumeData: (min,max,avg)", this.volumeData.minVal, this.volumeData.maxVal, this.volumeData.avgVal);

    // var data = new Uint8Array(128 * 128 * 256);
    var si = 0;
    var di;
    this.volumeData.values['flipY'] = false;
    for (var x = 0; x &lt; src_width; x++) {
        for (var y = 0; y &lt; src_height; y++) {
            for (var z = 0; z &lt; src_depth; z++) {
                di = this.volumeData.getAddress(offset_x + x, offset_y + y, offset_z + z);
                this.volumeData.values['image']['data'][ di ] = Math.floor(src[ si ] * mul);
                this.volumeData.values['image']['data'][ di + 1] = Math.floor(src[ si + 1 ] * mul);
                si++;
            }
        }
    }


    this.volumeData.values['needsUpdate'] = true;
    this.volumeData.onLoadSuccess();
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-dependency.html">dependency</a></li></ul><h3>Classes</h3><ul><li><a href="CameraCrew.html">CameraCrew</a></li><li><a href="ColorMap.html">ColorMap</a></li><li><a href="GeneralDataLoader.html">GeneralDataLoader</a></li><li><a href="leaf.html">leaf</a></li><li><a href="NativeImageLoader.html">NativeImageLoader</a></li><li><a href="OpenRayCaster.html">OpenRayCaster</a></li><li><a href="OpenVolumeData.html">OpenVolumeData</a></li><li><a href="PointDataLoader.html">PointDataLoader</a></li><li><a href="RayTracingPass.html">RayTracingPass</a></li><li><a href="RenderPass.html">RenderPass</a></li><li><a href="TestHarness.html">TestHarness</a></li><li><a href="THREE.OrbitControls.html">OrbitControls</a></li><li><a href="VolDataLoader.html">VolDataLoader</a></li><li><a href="VolumeEgressCoordinatePass.html">VolumeEgressCoordinatePass</a></li><li><a href="VolumeGeometry.html">VolumeGeometry</a></li><li><a href="VolumeIngressCoordinatePass.html">VolumeIngressCoordinatePass</a></li></ul><h3>Namespaces</h3><ul><li><a href="Colormaps.html">Colormaps</a></li><li><a href="MissingMath.html">MissingMath</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Tue Sep 20 2016 13:34:34 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
